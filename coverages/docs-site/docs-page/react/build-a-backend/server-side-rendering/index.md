[<- Back to index](../../../../docs-pages.md)

#  Snippets

Page: https://docs.amplify.aws/react/build-a-backend/server-side-rendering/

Coverage: 0.0%

#### `Terminal`

~~~
npm add aws-amplify @aws-amplify/adapter-nextjs

~~~

| | |
| -- | -- |
| Hash | `8689eafef8e07e47` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
import { createServerRunner } from "@aws-amplify/adapter-nextjs";
import outputs from "@/amplify_outputs.json";

export const { runWithAmplifyServerContext } = createServerRunner({
  config: outputs,
});

~~~

| | |
| -- | -- |
| Hash | `bf2e41aba91ab1d5` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
"use client";

import outputs from "@/amplify_outputs.json";
import { Amplify } from "aws-amplify";

Amplify.configure(outputs, {
  ssr: true, // required when using Amplify with Next.js
});

export default function RootLayoutThatConfiguresAmplifyOnTheClient({
  children,
}: {
  children: React.ReactNode;
}) {
  return children;
}

~~~

| | |
| -- | -- |
| Hash | `3baa0ac91eb98ddc` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
"use client";

import { Amplify } from "aws-amplify";
import outputs from "../amplify_outputs.json";

Amplify.configure(outputs, { ssr: true });

export default function ConfigureAmplifyClientSide() {
  return null;
}

~~~

| | |
| -- | -- |
| Hash | `f219aab938f63266` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
import ConfigureAmplifyClientSide from "@/components/ConfigureAmplifyClientSide";
import "./globals.css";

import type { Metadata } from "next";

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
<html lang="en">
  <body className="container pb-6">
    <>
<ConfigureAmplifyClientSide />
{children}
    </>
  </body>
</html>
  );
}

~~~

| | |
| -- | -- |
| Hash | `cbb6f8c4879ba10d` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
import { fetchAuthSession } from "aws-amplify/auth/server";
import { NextRequest, NextResponse } from "next/server";
import { runWithAmplifyServerContext } from "@/utils/amplifyServerUtils";

export async function middleware(request: NextRequest) {
  const response = NextResponse.next();

  const authenticated = await runWithAmplifyServerContext({
nextServerContext: { request, response },
operation: async (contextSpec) => {
  try {
    const session = await fetchAuthSession(contextSpec);
    return (
session.tokens?.accessToken !== undefined &&
session.tokens?.idToken !== undefined
    );
  } catch (error) {
    console.log(error);
    return false;
  }
},
  });

  if (authenticated) {
return response;
  }

  return NextResponse.redirect(new URL("/sign-in", request.url));
}

export const config = {
  matcher: [
/*
 * Match all request paths except for the ones starting with:
 * - api (API routes)
 * - _next/static (static files)
 * - _next/image (image optimization files)
 * - favicon.ico (favicon file)
 */
"/((?!api|_next/static|_next/image|favicon.ico|sign-in).*)",
  ],
};

~~~

| | |
| -- | -- |
| Hash | `10c6492fd438d91e` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `next.config.js`

~~~
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
serverComponentsExternalPackages: ["@aws-crypto"],
  },
};

~~~

| | |
| -- | -- |
| Hash | `557d8255f490c784` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
import { cookies } from "next/headers";
import { getCurrentUser } from "aws-amplify/auth/server";
import { runWithAmplifyServerContext } from "@/utils/amplifyServerUtils";

// This page always dynamically renders per request
export const dynamic = "force-dynamic";

export default async function AuthGetCurrentUserServer() {
  try {
const currentUser = await runWithAmplifyServerContext({
  nextServerContext: { cookies },
  operation: (contextSpec) => getCurrentUser(contextSpec),
});

return (
  <AuthFetchResult
    description="The API is called on the server side."
    data={currentUser}
  />
);
  } catch (error) {
console.error(error);
return <p>Something went wrong...</p>;
  }
}

~~~

| | |
| -- | -- |
| Hash | `78c26838ef9c22f4` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
import { getUrl } from "aws-amplify/storage/server";
import Image from "next/image";
import { runWithAmplifyServerContext } from "@/utils/amplifyServerUtils";

// Re-render this page every 60 minutes
export const revalidate = 60 * 60; // in seconds

export default async function StaticallyRenderedPage() {
  try {
const splashUrl = await runWithAmplifyServerContext({
  nextServerContext: null,
  operation: (contextSpec) =>
    getUrl(contextSpec, {
key: "splash.png",
    }),
});

return (
  <Image
    src={splashUrl.url.toString()}
    alt="Splash Image"
    width={500}
    height={500}
  />
);
  } catch (error) {
console.error(error);
return <p>Something went wrong...</p>;
  }
}

~~~

| | |
| -- | -- |
| Hash | `557ac1e38174bddd` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
import { getCurrentUser } from "aws-amplify/auth/server";
import { cookies } from "next/headers";
import { NextResponse } from "next/server";
import { runWithAmplifyServerContext } from "@/utils/amplifyServerUtils";

export async function GET() {
  const user = await runWithAmplifyServerContext({
nextServerContext: { cookies },
operation: (contextSpec) => getCurrentUser(contextSpec),
  });

  return NextResponse.json({ user });
}

~~~

| | |
| -- | -- |
| Hash | `3580536425fbfa26` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
export const getServerSideProps: GetServerSideProps = async ({ req, res }) => {
  const currentUser = await runWithAmplifyServerContext({
nextServerContext: { request: req, response: res },
operation: (contextSpec) => getCurrentUser(contextSpec),
  });

  return { props: { currentUser } };
};

~~~

| | |
| -- | -- |
| Hash | `c485918a99f92f58` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

#### `Unnamed Snippet`

~~~
export async function getStaticProps() {
  const splashUrl = await runWithAmplifyServerContext({
nextServerContext: null,
operation: (contextSpec) => getUrl(contextSpec, { key: "splash.png" }),
  });

  return {
props: { imageUrl: splashUrl.url.toString() },
revalidate: (splashUrl.expiresAt.getTime() - Date.now()) / 1000, // in seconds
  };
}

~~~

| | |
| -- | -- |
| Hash | `ee0e7701ec29a7a3` |
| Covered | ❌ |

##### Covering Regions

- *None*

---

[<- Back to index](../../../../docs-pages.md)
